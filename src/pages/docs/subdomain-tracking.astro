---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Subdomain Tracking - Infinity Metrics">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-4">
          <a href="/docs" class="hover:text-gray-700">Documentation</a>
          <span>→</span>
          <span class="text-gray-900">Subdomain Tracking</span>
        </nav>
        <h1 class="text-3xl font-bold text-gray-900">Subdomain Tracking</h1>
        <p class="mt-2 text-gray-600">
          Track user behavior across multiple subdomains with unified analytics
        </p>
      </div>

      <!-- Overview -->
      <section class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Overview</h2>
        <p class="text-gray-600 mb-4">
          Subdomain tracking allows you to monitor user behavior across
          different subdomains of your website as a single, unified experience.
          This is essential for businesses with complex web architectures that
          span multiple subdomains such as app.example.com, blog.example.com,
          and shop.example.com.
        </p>

        <div class="bg-gray-50 border border-blue-200 rounded-lg p-4">
          <h3 class="font-medium text-gray-900 mb-2">Use Cases</h3>
          <ul class="text-gray-800 space-y-1 text-sm">
            <li>• SaaS applications with separate app and marketing sites</li>
            <li>• E-commerce stores with dedicated checkout subdomains</li>
            <li>• Documentation sites hosted on separate subdomains</li>
            <li>• Multi-brand websites under the same parent domain</li>
            <li>• A/B testing across different subdomain experiences</li>
          </ul>
        </div>
      </section>

      <!-- Basic Setup -->
      <section class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">Basic Setup</h2>

        <div class="space-y-6">
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Single Script Configuration
            </h3>
            <p class="text-gray-600 mb-3">
              The simplest approach is to use the same tracking script across
              all subdomains with subdomain tracking enabled.
            </p>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`<script>
(function() {
  window.infinityMetrics = window.infinityMetrics || [];
  window.infinityMetrics.push(['config', {
    apiKey: 'your-api-key',
    domain: '.example.com', // Note the leading dot
    trackSubdomains: true,
    cookieDomain: '.example.com',
    crossDomainTracking: true
  }]);
  
  // Load the analytics script
  var script = document.createElement('script');
  script.src = 'https://cdn.infinitymetrics.com/analytics.js';
  script.async = true;
  document.head.appendChild(script);
})();
</script>`}</code></pre>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              JavaScript SDK Configuration
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`import { InfinityMetrics } from '@infinity-metrics/web';

const analytics = new InfinityMetrics({
  apiKey: 'your-api-key',
  domain: '.example.com',
  trackSubdomains: true,
  crossDomainTracking: {
    enabled: true,
    allowedDomains: [
      'app.example.com',
      'blog.example.com',
      'shop.example.com',
      'docs.example.com'
    ]
  },
  cookies: {
    domain: '.example.com',
    sameSite: 'Lax',
    secure: true
  }
});`}</code></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Cross-Subdomain User Tracking -->
      <section class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">
          Cross-Subdomain User Tracking
        </h2>

        <div class="space-y-6">
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              User ID Persistence
            </h3>
            <p class="text-gray-600 mb-3">
              Maintain the same user identity across subdomains to track
              complete user journeys.
            </p>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Set user ID that persists across subdomains
analytics.identify('user_12345', {
  email: 'user@example.com',
  name: 'John Doe',
  plan: 'premium'
});

// Track events with consistent user context
analytics.track('subdomain_visit', {
  subdomain: window.location.hostname,
  referrer_subdomain: document.referrer ? 
    new URL(document.referrer).hostname : null,
  page_path: window.location.pathname
});`}</code></pre>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Session Continuity
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Configure session tracking across subdomains
analytics.config({
  session: {
    timeout: 30 * 60 * 1000, // 30 minutes
    trackAcrossSubdomains: true,
    persistAcrossTabs: true
  }
});

// Track subdomain transitions
analytics.track('subdomain_transition', {
  from_subdomain: sessionStorage.getItem('previous_subdomain'),
  to_subdomain: window.location.hostname,
  transition_time: new Date().toISOString(),
  session_id: analytics.getSessionId()
});

// Store current subdomain for next transition
sessionStorage.setItem('previous_subdomain', window.location.hostname);`}</code></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Subdomain-Specific Tracking -->
      <section class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">
          Subdomain-Specific Tracking
        </h2>

        <div class="space-y-6">
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Subdomain Context
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Add subdomain context to all events
function getSubdomainContext() {
  const hostname = window.location.hostname;
  const subdomain = hostname.split('.')[0];
  
  return {
    subdomain: subdomain,
    full_domain: hostname,
    subdomain_type: getSubdomainType(subdomain)
  };
}

function getSubdomainType(subdomain) {
  const types = {
    'app': 'application',
    'blog': 'content',
    'shop': 'ecommerce',
    'docs': 'documentation',
    'api': 'service',
    'www': 'marketing'
  };
  
  return types[subdomain] || 'other';
}

// Track with subdomain context
analytics.track('page_view', {
  ...getSubdomainContext(),
  page_title: document.title,
  page_path: window.location.pathname
});`}</code></pre>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Subdomain-Specific Events
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Define subdomain-specific tracking logic
class SubdomainTracker {
  constructor(analytics) {
    this.analytics = analytics;
    this.subdomain = window.location.hostname.split('.')[0];
    this.setupSubdomainTracking();
  }
  
  setupSubdomainTracking() {
    switch(this.subdomain) {
      case 'app':
        this.trackAppEvents();
        break;
      case 'blog':
        this.trackContentEvents();
        break;
      case 'shop':
        this.trackEcommerceEvents();
        break;
      default:
        this.trackGenericEvents();
    }
  }
  
  trackAppEvents() {
    // Track app-specific interactions
    this.analytics.track('app_loaded', {
      subdomain: 'app',
      user_authenticated: this.isUserAuthenticated(),
      app_version: this.getAppVersion()
    });
  }
  
  trackContentEvents() {
    // Track blog/content interactions
    this.analytics.track('content_view', {
      subdomain: 'blog',
      content_type: this.getContentType(),
      reading_time: this.estimateReadingTime()
    });
  }
  
  trackEcommerceEvents() {
    // Track shopping interactions
    this.analytics.track('shop_visit', {
      subdomain: 'shop',
      cart_items: this.getCartItemCount(),
      visitor_type: this.getVisitorType()
    });
  }
}`}</code></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Cross-Domain Linking -->
      <section class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">
          Cross-Domain Linking
        </h2>

        <div class="space-y-6">
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Automatic Link Decoration
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Automatically add tracking parameters to cross-subdomain links
analytics.decorateLinks({
  domains: [
    'app.example.com',
    'blog.example.com', 
    'shop.example.com'
  ],
  parameter: '_im_uid', // Custom parameter name
  autoDecorate: true
});

// Manual link decoration for specific links
const link = document.querySelector('#cross-subdomain-link');
analytics.decorateLink(link, {
  user_id: analytics.getUserId(),
  session_id: analytics.getSessionId(),
  source_subdomain: window.location.hostname
});`}</code></pre>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Form Tracking Across Subdomains
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Track form submissions that redirect to other subdomains
function trackCrossSubdomainForm(formId, targetSubdomain) {
  const form = document.getElementById(formId);
  
  form.addEventListener('submit', function(e) {
    // Track form submission
    analytics.track('form_submit', {
      form_id: formId,
      source_subdomain: window.location.hostname,
      target_subdomain: targetSubdomain,
      form_data: getFormData(form)
    });
    
    // Add tracking parameters to form action
    const actionUrl = new URL(form.action);
    actionUrl.searchParams.set('_im_uid', analytics.getUserId());
    actionUrl.searchParams.set('_im_sid', analytics.getSessionId());
    form.action = actionUrl.toString();
  });
}

// Usage
trackCrossSubdomainForm('newsletter-signup', 'app.example.com');`}</code></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Analytics and Reporting -->
      <section class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">
          Analytics and Reporting
        </h2>

        <div class="space-y-6">
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Subdomain Performance Metrics
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Track subdomain-specific performance metrics
analytics.track('performance_metrics', {
  subdomain: window.location.hostname,
  page_load_time: performance.timing.loadEventEnd - 
                   performance.timing.navigationStart,
  dom_ready_time: performance.timing.domContentLoadedEventEnd - 
                   performance.timing.navigationStart,
  first_paint: performance.getEntriesByType('paint')
                .find(entry => entry.name === 'first-paint')?.startTime,
  largest_contentful_paint: getLargestContentfulPaint(),
  cumulative_layout_shift: getCumulativeLayoutShift()
});`}</code></pre>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              User Journey Analysis
            </h3>
            <div
              class="bg-gray-900 rounded-lg p-4 text-gray-100 font-mono text-sm overflow-x-auto"
            >
              <pre><code>{`// Track complete user journey across subdomains
class UserJourneyTracker {
  constructor(analytics) {
    this.analytics = analytics;
    this.journey = this.loadJourney();
  }
  
  trackSubdomainVisit() {
    const visit = {
      subdomain: window.location.hostname,
      timestamp: new Date().toISOString(),
      page: window.location.pathname,
      referrer: document.referrer
    };
    
    this.journey.visits.push(visit);
    this.saveJourney();
    
    // Track journey milestone
    this.analytics.track('journey_step', {
      step_number: this.journey.visits.length,
      subdomain: visit.subdomain,
      journey_duration: this.getJourneyDuration(),
      unique_subdomains: this.getUniqueSubdomains().length
    });
  }
  
  loadJourney() {
    const stored = localStorage.getItem('user_journey');
    return stored ? JSON.parse(stored) : { visits: [], started: new Date().toISOString() };
  }
  
  saveJourney() {
    localStorage.setItem('user_journey', JSON.stringify(this.journey));
  }
  
  getUniqueSubdomains() {
    return [...new Set(this.journey.visits.map(v => v.subdomain))];
  }
}`}</code></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Troubleshooting -->
      <section class="mb-12 bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">
          Troubleshooting
        </h2>

        <div class="space-y-4">
          <div class="border-l-4 border-gray-400 pl-4">
            <h3 class="font-medium text-gray-700">Cookie Issues</h3>
            <p class="text-gray-700 text-sm mb-2">
              Users not tracked across subdomains
            </p>
            <ul class="text-gray-700 text-sm space-y-1">
              <li>
                • Ensure cookie domain starts with a dot (e.g., '.example.com')
              </li>
              <li>• Check that all subdomains use HTTPS in production</li>
              <li>• Verify SameSite cookie settings are compatible</li>
            </ul>
          </div>

          <div class="border-l-4 border-gray-400 pl-4">
            <h3 class="font-medium text-gray-700">Session Breaks</h3>
            <p class="text-gray-700 text-sm mb-2">
              Sessions reset when moving between subdomains
            </p>
            <ul class="text-gray-700 text-sm space-y-1">
              <li>
                • Check that session timeout is consistent across subdomains
              </li>
              <li>• Ensure proper cross-domain linking is implemented</li>
              <li>• Verify that user IDs are properly shared</li>
            </ul>
          </div>

          <div class="border-l-4 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-900">Missing Events</h3>
            <p class="text-gray-800 text-sm mb-2">
              Events not appearing for some subdomains
            </p>
            <ul class="text-gray-700 text-sm space-y-1">
              <li>• Confirm analytics script is loaded on all subdomains</li>
              <li>• Check that API key and configuration are identical</li>
              <li>• Use browser dev tools to verify network requests</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Navigation -->
      <div
        class="flex justify-between items-center pt-8 border-t border-gray-200"
      >
        <a
          href="/docs/revenue-tracking"
          class="flex items-center text-gray-700 hover:text-black"
        >
          ← Revenue Tracking
        </a>
        <a
          href="/docs"
          class="flex items-center text-gray-700 hover:text-black"
        >
          Back to Documentation →
        </a>
      </div>
    </div>
  </div>
</Layout>
